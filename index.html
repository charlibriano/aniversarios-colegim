<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calend√°rio de Anivers√°rios ‚Äî Colegim</title>
<meta name="theme-color" content="#f3f6ff">
<style>
:root{
  --bg:#f3f6ff;
  --bg2:#eef2ff;
  --card:#ffffff;
  --soft:#f7f9ff;
  --text:#141c33;
  --muted:#5b6a9a;
  --accent:#4f5bff;
  --accent2:#16a34a;
  --line:rgba(0,0,0,.08);
  --shadow:0 14px 34px rgba(14,28,80,.10);
  --shadow2:0 10px 22px rgba(14,28,80,.10);
  --r:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  overflow-x:hidden;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,Helvetica,sans-serif;
  color:var(--text);
  background:
    radial-gradient(900px 520px at 10% 0%, rgba(79,91,255,.18), rgba(0,0,0,0) 60%),
    radial-gradient(900px 520px at 90% 10%, rgba(22,163,74,.12), rgba(0,0,0,0) 62%),
    linear-gradient(180deg, var(--bg), var(--bg2));
}
.container{max-width:1100px; margin:0 auto; padding:18px 14px 120px;}

.header{
  border:1px solid var(--line);
  border-radius: calc(var(--r) + 6px);
  box-shadow: var(--shadow);
  background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.78));
  overflow:hidden;
}
.headerInner{padding:16px 16px 12px;}
.topRow{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;}
h1{margin:0; font-size:20px; letter-spacing:.2px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
.sub{margin:8px 0 0; color:var(--muted); font-size:13px; line-height:1.45;}
.badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(79,91,255,.08); color: rgba(20,28,51,.95);}

.controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;}
.btn{
  -webkit-appearance:none; appearance:none;
  border:1px solid var(--line);
  background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(247,249,255,.92));
  color:var(--text);
  padding:10px 14px;
  border-radius:999px;
  cursor:pointer;
  box-shadow: var(--shadow2);
  transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
  font-size:13px;
}
.btn:hover{transform: translateY(-1px); border-color: rgba(0,0,0,.14);}
.btn:active{transform: translateY(0px);}
.btn.primary{border-color: rgba(79,91,255,.22); background: linear-gradient(180deg, rgba(79,91,255,.14), rgba(79,91,255,.08));}
.btn:focus{outline: 2px solid rgba(79,91,255,.40); outline-offset:2px;}

.pill{
  display:inline-flex; align-items:center; gap:8px;
  font-size:12px; color:var(--muted);
  border:1px solid var(--line);
  padding:9px 12px;
  border-radius:999px;
  background: rgba(255,255,255,.70);
}

.layout{margin-top:14px; display:grid; grid-template-columns: 1.25fr .75fr; gap:14px;}
@media (max-width: 960px){ .layout{grid-template-columns:1fr;} }

.card{
  border:1px solid var(--line);
  border-radius: var(--r);
  background: rgba(255,255,255,.86);
  box-shadow: var(--shadow);
  overflow:hidden;
}
.cardInner{padding:14px;}

.monthbar{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px;}
.monthTitle{font-weight:900; font-size:16px; letter-spacing:.2px;}

.weekdays, .days{display:grid; grid-template-columns:repeat(7,1fr); gap:8px;}
.weekdays div{text-align:center; font-size:12px; color:var(--muted); padding:4px 0;}

.day{
  background: linear-gradient(180deg, rgba(247,249,255,.92), rgba(255,255,255,.92)); border-radius: 14px; padding:10px; min-height:64px; cursor:pointer;
  border:1px solid rgba(0,0,0,.07);
  position:relative;
  transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
}
.day:hover{ border-color: rgba(0,0,0,.12); transform: translateY(-1px); }
.day.muted{ opacity:.35; cursor:default; transform:none !important; }
.day.selected{ box-shadow: 0 0 0 2px rgba(79,91,255,.20) inset, 0 10px 18px rgba(14,28,80,.06); border-color: rgba(79,91,255,.22); }
.day.today{ box-shadow: 0 0 0 2px rgba(79,91,255,.50) inset, 0 10px 18px rgba(14,28,80,.06); }
.day.bday{ background: linear-gradient(180deg, rgba(236,253,245,.95), rgba(255,255,255,.92)); box-shadow: 0 0 0 2px rgba(22,163,74,.45) inset; }
.day.bday:before{ content:""; position:absolute; right:-18px; top:-18px; width:60px;height:60px;
  background: radial-gradient(circle at 30% 30%, rgba(22,163,74,.32), rgba(22,163,74,0) 62%);
  transform: rotate(18deg); pointer-events:none;
}
.day .n{ font-size:14px; font-weight:900; display:flex; align-items:center; gap:6px;  white-space:nowrap;}

.miniBadge{ font-size:11px; padding:3px 7px; border-radius:999px; border:1px solid rgba(0,0,0,.08); background: rgba(22,163,74,.10); color: rgba(20,28,51,.90);}
.day .p{ margin-top:8px; font-size:11px; color:var(--muted); overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }

.h2{margin:0 0 10px; font-size:14px; letter-spacing:.2px;}
.note{margin:0; color:var(--muted); font-size:13px; line-height:1.4;}
.list{margin:10px 0 0; padding:0; list-style:none; display:flex; flex-direction:column; gap:8px;}
.li{
  border:1px solid rgba(0,0,0,.08);
  background: rgba(247,249,255,.90);
  border-radius: 14px;
  padding:10px;
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:flex-start;
}
.li strong{font-size:13px}
.li span{font-size:12px; color:var(--muted); white-space:nowrap}
.small{font-size:12px; color:var(--muted);}

.floatToday{position:fixed; right:14px; bottom:14px; z-index:50;}
.toast{position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); background: rgba(255,255,255,.96);
  border:1px solid var(--line); color: rgba(20,28,51,.96); padding:10px 12px; border-radius: 999px;
  box-shadow: var(--shadow2); opacity:0; pointer-events:none; transition: opacity .16s ease, transform .16s ease; z-index: 10000; font-size: 13px;
}
.toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px);}

.modalOverlay{
  position:fixed; inset:0; display:none; z-index:9999;
  background: rgba(8,12,24,.40);
  padding: 14px;
}
.modalOverlay.show{display:flex; align-items:flex-end; justify-content:center;}
.modal{
  width:min(760px, 100%);
  max-height: 82vh;
  overflow:auto;
  border-radius: 20px;
  border:1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.96);
  box-shadow: var(--shadow);
}
.modalHeader{
  position:sticky; top:0;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding: 12px 12px;
  border-bottom:1px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.96);
}
.modalHeader .t{font-weight:950; font-size:16px; letter-spacing:.2px;}
.iconBtn{
  border:1px solid rgba(0,0,0,.10);
  background: rgba(247,249,255,.92);
  color: rgba(20,28,51,.96);
  border-radius: 999px;
  padding: 8px 10px;
  cursor:pointer;
}
.modalBody{ padding: 12px; }
.item{
  background: rgba(247,249,255,.92);
  border-radius: 16px;
  padding:12px;
  margin-bottom:10px;
  border:1px solid rgba(0,0,0,.08);
  box-shadow: 0 10px 18px rgba(14,28,80,.08);
}
.itemTop{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-start;}
.itemTop strong{font-size:15px;}
.dateTag{font-size:12px; color: var(--muted); border:1px solid rgba(0,0,0,.10); padding:6px 10px; border-radius:999px; background: rgba(255,255,255,.80);}
.msg{font-size:12.5px; margin-top:10px; color: #065f46; line-height:1.35; border:1px solid rgba(22,163,74,.20);
  background: linear-gradient(90deg, rgba(22,163,74,.10), rgba(79,91,255,.10));
  border-radius: 14px; padding:10px 12px;
}
.actions{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;}
.smallBtn{border:1px solid rgba(0,0,0,.10); background: rgba(255,255,255,.92); color: rgba(20,28,51,.96); padding:8px 10px; border-radius: 999px; cursor:pointer; font-size:12px;}
.smallBtn:hover{border-color: rgba(0,0,0,.16);}

#confetti{ position:fixed; inset:0; pointer-events:none; z-index:9998; }

@media (max-width: 720px){
  .container{ padding:14px 10px 110px; }
  h1{ font-size:18px; }
  .controls{ justify-content:flex-start; }
  .day{ min-height:52px; padding:8px; border-radius:12px; }
  .day .p{ display:none; }
}

.li.clickable{ cursor:pointer; }
.li.clickable:hover{ border-color: rgba(79,91,255,.25); box-shadow: 0 0 0 2px rgba(79,91,255,.10) inset; }


/* search */
.searchRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;}
.searchWrap{flex:1; min-width:220px; position:relative;}
.searchInput{
  width:100%;
  padding:11px 44px 11px 14px;
  border-radius: 999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.92);
  color: var(--text);
  box-shadow: var(--shadow2);
  font-size:13px;
}
.searchInput:focus{outline:2px solid rgba(79,91,255,.35); outline-offset:2px;}
.clearBtn{
  position:absolute; right:10px; top:50%; transform:translateY(-50%);
  border:1px solid rgba(0,0,0,.10);
  background: rgba(247,249,255,.92);
  border-radius:999px;
  padding:6px 8px;
  cursor:pointer;
  font-size:12px;
}
.searchMeta{font-size:12px; color: var(--muted);}
.day.match{ border-color: rgba(79,91,255,.28) !important; box-shadow: 0 0 0 2px rgba(79,91,255,.14) inset, 0 10px 18px rgba(14,28,80,.06); }

@media (prefers-reduced-motion: reduce){
  .day, .btn, .toast{ transition:none !important; }
}
</style>
</head>
<body>
<canvas id="confetti"></canvas>

<div class="container">
  <section class="header">
    <div class="headerInner">
      <div class="topRow">
        <div style="min-width:260px">
          <h1>üéâ Calend√°rio de Anivers√°rios ‚Äî Colegim <span class="badge">mensagens b√≠blicas</span></h1>
          <div class="sub">Toque no dia para abrir o modal com mensagem + copiar + WhatsApp.</div>
        </div>
        <div class="controls">
          <button class="btn" type="button" id="prevBtn">‚óÄ Anterior</button>
          <button class="btn" type="button" id="nextBtn">Pr√≥ximo ‚ñ∂</button>
          <button class="btn primary" type="button" id="icsBtn">üìÜ Adicionar ao calend√°rio</button>
          <span class="pill" id="countPill">‚Äî</span>
        </div>
<div class="searchRow" style="width:100%">
  <div class="searchWrap">
    <input class="searchInput" id="searchInput" type="text" inputmode="search" autocomplete="off" placeholder="üîé Pesquisar por nome (ex: Cin, Fel, Tati)">
    <button class="clearBtn" type="button" id="clearSearchBtn" title="Limpar">‚úñ</button>
  </div>
  <span class="pill" id="searchPill">Digite para buscar</span>
</div>
      </div>
    </div>
  </section>

  <div class="layout">
    <section class="card">
      <div class="cardInner">
        <div class="monthbar">
          <div class="monthTitle" id="monthTitle">‚Äî</div>
          <span class="pill">üü© Anivers√°rio ¬∑ üü¶ Hoje</span>
        </div>

        <div class="weekdays">
          <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>S√°b</div>
        </div>
        <div class="days" id="days"></div>
      </div>
    </section>

    <aside style="display:flex; flex-direction:column; gap:14px;">
  <section class="card">
    <div class="cardInner">
      <div class="h2">‚è≠Ô∏è Pr√≥ximos anivers√°rios</div>
      <p class="note" style="margin-bottom:10px;">Veja quem faz anivers√°rio em breve (7 / 15 / 30 dias).</p>
<div style="margin:10px 0 6px;">
  <div class="h2">üîé Resultado da busca</div>
  <p class="note" style="margin:0 0 8px;">Mostra as pessoas encontradas e abre o dia ao tocar.</p>
  <ul class="list" id="searchList" style="margin-top:0;"></ul>
  <div class="small" id="searchEmpty" style="display:none; margin-top:8px;">Nenhum nome encontrado.</div>
</div>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
        <button class="btn" type="button" id="up7Btn">7 dias</button>
        <button class="btn" type="button" id="up15Btn">15 dias</button>
        <button class="btn primary" type="button" id="up30Btn">30 dias</button>
        <span class="pill" id="upCountPill">‚Äî</span>
      </div>

      <ul class="list" id="upcomingList" style="margin-top:0;"></ul>
      <div class="small" id="upcomingEmpty" style="display:none; margin-top:8px;">
        Nenhum anivers√°rio nos pr√≥ximos dias escolhidos.
      </div>
      <div class="small" style="margin-top:10px;">Dica: toque em um nome para ir direto no dia (abre o modal).</div>
    </div>
  </section>

  <section class="card">
    <div class="cardInner">
      <div class="h2">üìå Observa√ß√µes do m√™s</div>
        <p class="note" id="monthSummary">‚Äî</p>
        <ul class="list" id="monthList"></ul>
        <p class="small" style="margin-top:10px">Dica: clique no dia do calend√°rio para abrir as mensagens.</p>
    </div>
  </section>
</aside>
</div>
</div>

<div class="floatToday">
  <button class="btn primary" type="button" id="todayBtn">üìç Hoje</button>
</div>

<div class="toast" id="toast">Copiado ‚úÖ</div>

<div class="modalOverlay" id="modalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modalHeader">
      <div class="t" id="modalTitle">‚Äî</div>
      <button class="iconBtn" type="button" id="closeModalBtn">Fechar ‚úñ</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>
const birthdays = {
  "02-15": [
    "Cintia Cordeiro",
    "Felipe"
  ],
  "06-15": [
    "Cintia Silva"
  ],
  "04-12": [
    "Clayton"
  ],
  "02-18": [
    "Dayane"
  ],
  "11-26": [
    "Fanin"
  ],
  "12-06": [
    "Fernanda"
  ],
  "05-09": [
    "Gau"
  ],
  "11-03": [
    "Jorge"
  ],
  "03-04": [
    "Luiz (curanda)"
  ],
  "08-24": [
    "Nair"
  ],
  "02-11": [
    "Pedro (Nagai)"
  ],
  "01-09": [
    "PT"
  ],
  "01-22": [
    "Regio"
  ],
  "04-22": [
    "Tati"
  ]
};
const messages  = {
  "Cintia Cordeiro": "üéâüìñ Cintia, feliz anivers√°rio! Que o Senhor te aben√ßoe e te guarde; e te conceda paz. (N√∫meros 6:24-26)",
  "Felipe": "üôèüìñ Felipe, feliz anivers√°rio! Entregue seus caminhos ao Senhor; Ele cuidar√° de voc√™. (Salmo 37:5)",
  "Cintia Silva": "‚ú®üìñ Cintia, feliz anivers√°rio! Confie no Senhor de todo o cora√ß√£o; Ele endireitar√° seus passos. (Prov√©rbios 3:5-6)",
  "Clayton": "üéÇüìñ Clayton, feliz anivers√°rio! Deus tem planos de paz e um futuro cheio de esperan√ßa para voc√™. (Jeremias 29:11)",
  "Dayane": "üéâüìñ Dayane, feliz anivers√°rio! N√£o temas: Deus te fortalece, ajuda e sustenta. (Isa√≠as 41:10)",
  "Fernanda": "üôèüìñ Fernanda, feliz anivers√°rio! Que a paz de Deus guarde seu cora√ß√£o e seus pensamentos. (Filipenses 4:6-7)",
  "Gau": "‚ú®üìñ Gau, feliz anivers√°rio! O Senhor √© seu Pastor; nada te faltar√°. (Salmo 23:1)",
  "Jorge": "üéÇüìñ Jorge, feliz anivers√°rio! Que Deus te encha de alegria e paz, transbordando em esperan√ßa. (Romanos 15:13)",
  "Luiz (curanda)": "üéâüìñ Luiz, feliz anivers√°rio! Que o Senhor te guarde em todo tempo, na sa√≠da e na chegada. (Salmo 121:7-8)",
  "Pedro (Nagai)": "üôèüìñ Pedro, feliz anivers√°rio! Que Deus fa√ßa al√©m do que voc√™ pede ou imagina. (Ef√©sios 3:20)",
  "PT": "‚ú®üìñ PT, feliz anivers√°rio! Que Deus te conceda sabedoria para cada decis√£o. (Tiago 1:5)",
  "Regio": "üéÇüìñ Regio, feliz anivers√°rio! Que suas for√ßas sejam renovadas e voc√™ siga com √¢nimo. (Isa√≠as 40:31)",
  "Tati": "üéâüìñ Tati, feliz anivers√°rio! Que a paz de Jesus seja sua por√ß√£o em todo momento. (Jo√£o 14:27)"
};
const defaultMsg = "üéâüìñ Feliz anivers√°rio! Que Deus aben√ßoe sua vida com sa√∫de, paz e alegria. (N√∫meros 6:24-26)";

// mensagens extras autom√°ticas (n√£o repetem por pessoa)
const extraPool = [
  "Que seu novo ciclo seja cheio da presen√ßa de Deus e de novas conquistas.",
  "Que Deus te conduza com paz, sabedoria e alegria neste novo ano de vida.",
  "Que o Senhor fortale√ßa seus passos e cumpra Suas promessas sobre voc√™.",
  "Que este novo tempo seja marcado por crescimento, f√© e dire√ß√£o divina.",
  "Que a gra√ßa de Deus te envolva e te leve a viver coisas extraordin√°rias.",
  "Que voc√™ experimente novos n√≠veis de alegria, prop√≥sito e favor.",
  "Que o Senhor renove suas for√ßas e te surpreenda em cada detalhe.",
  "Que sua caminhada seja guiada pela luz e pelo amor de Deus.",
  "Que este novo ciclo seja repleto de b√™n√ß√£os e realiza√ß√µes.",
  "Que Deus abra portas e estabele√ßa Seus planos sobre sua vida.",
  "Que voc√™ viva um ano de plenitude, paz e grandes vit√≥rias.",
  "Que o Senhor te sustente e te leve al√©m do que voc√™ imagina.",
  "Que sua f√© seja fortalecida e seu cora√ß√£o cheio de esperan√ßa.",
  "Que Deus te conceda um tempo de crescimento e colheita abundante.",
  "Que este seja um ano de testemunhos e milagres.",
  "Que a alegria do Senhor seja sua for√ßa todos os dias.",
  "Que voc√™ viva os sonhos que Deus preparou para voc√™.",
  "Que a presen√ßa de Deus seja constante em cada novo passo.",
  "Que este ciclo seja marcado por favor e gra√ßa sem medida.",
  "Que Deus te surpreenda com coisas maiores e melhores."
];

const extraAssigned = {};
function getExtraMessage(name){
  if (extraAssigned[name]) return extraAssigned[name];
  // deterministic pick based on name hash (prevents repetition per person)
  let hash = 0;
  for (let i=0;i<name.length;i++) hash = (hash<<5) - hash + name.charCodeAt(i);
  hash = Math.abs(hash);
  const msg = extraPool[hash % extraPool.length];
  extraAssigned[name] = msg;
  return msg;
}

const months=["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

const daysEl = document.getElementById("days");
const monthTitleEl = document.getElementById("monthTitle");
const countPillEl  = document.getElementById("countPill");
const toastEl      = document.getElementById("toast");
const monthSummaryEl = document.getElementById("monthSummary");
const monthListEl = document.getElementById("monthList");


const up7Btn = document.getElementById("up7Btn");
const up15Btn = document.getElementById("up15Btn");
const up30Btn = document.getElementById("up30Btn");
const upCountPillEl = document.getElementById("upCountPill");
const upcomingListEl = document.getElementById("upcomingList");
const upcomingEmptyEl = document.getElementById("upcomingEmpty");

const searchInput = document.getElementById("searchInput");
const clearSearchBtn = document.getElementById("clearSearchBtn");

const icsBtn = document.getElementById("icsBtn");

function escapeICS(text){
  return (text || "")
    .replace(/\\/g, "\\\\")
    .replace(/\n/g, "\\n")
    .replace(/;/g, "\\;")
    .replace(/,/g, "\\,");
}
function yyyymmdd(dateObj){
  const y = dateObj.getFullYear();
  const m = String(dateObj.getMonth()+1).padStart(2,"0");
  const d = String(dateObj.getDate()).padStart(2,"0");
  return "" + y + m + d;
}
function pad2n(n){ return String(n).padStart(2,"0"); }

function buildICS(){
  const now = new Date();
  const year = now.getFullYear();
  const dtstamp = yyyymmdd(now) + "T" +
    pad2n(now.getHours()) + pad2n(now.getMinutes()) + pad2n(now.getSeconds()) + "Z";

  // Use one all-day recurring event per person (YEARLY), starting this year
  let lines = [];
  lines.push("BEGIN:VCALENDAR");
  lines.push("VERSION:2.0");
  lines.push("PRODID:-//Colegim//Calendario de Aniversarios//PT-BR");
  lines.push("CALSCALE:GREGORIAN");
  lines.push("METHOD:PUBLISH");

  Object.keys(birthdays).sort().forEach((key)=>{
    const parts = key.split("-");
    const mm = parseInt(parts[0],10);
    const dd = parseInt(parts[1],10);
    const start = new Date(year, mm-1, dd);

    (birthdays[key] || []).forEach((name)=>{
      const uid = "colegim-" + escapeICS(normalizeText(name)) + "-" + parts[0] + parts[1] + "@local";
      const summary = "Anivers√°rio - " + name;
      const desc = getExtraMessage(name) + "\n\n" + (messages[name] || defaultMsg);

      lines.push("BEGIN:VEVENT");
      lines.push("UID:" + uid);
      lines.push("DTSTAMP:" + dtstamp);
      lines.push("SUMMARY:" + escapeICS(summary));
      lines.push("DESCRIPTION:" + escapeICS(desc));
      lines.push("DTSTART;VALUE=DATE:" + yyyymmdd(start));
      lines.push("RRULE:FREQ=YEARLY");
      lines.push("TRANSP:TRANSPARENT");
      lines.push("END:VEVENT");
    });
  });

  lines.push("END:VCALENDAR");
  return lines.join("\r\n");
}

function downloadICS(){
  const ics = buildICS();
  const filename = "aniversarios-colegim.ics";

  // Prefer Blob download
  try{
    const blob = new Blob([ics], {type: "text/calendar;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 800);
    showToast("Arquivo .ics gerado ‚úÖ");
  }catch(err){
    // Fallback: open data URL
    const dataUrl = "data:text/calendar;charset=utf-8," + encodeURIComponent(ics);
    window.open(dataUrl, "_blank");
    showToast("Abrindo .ics‚Ä¶");
  }
}

icsBtn.addEventListener("click", downloadICS);

const searchPillEl = document.getElementById("searchPill");
const searchListEl = document.getElementById("searchList");
const searchEmptyEl = document.getElementById("searchEmpty");

function normalizeText(s){
  return (s || "")
    .toString()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .trim();
}

function buildNameIndex(){
  const idx = [];
  Object.keys(birthdays).forEach((key)=>{
    (birthdays[key] || []).forEach((name)=>{
      idx.push({ name, n: normalizeText(name), key });
    });
  });
  // stable sort
  idx.sort((a,b)=> a.name.localeCompare(b.name));
  return idx;
}
const nameIndex = buildNameIndex();

function keyToDateThisOrNext(key){
  const base = toLocalMidnight(new Date());
  const parts = parseMMDD(key);
  let dt = new Date(base.getFullYear(), parts.mm - 1, parts.dd);
  if (dt < base) dt = new Date(base.getFullYear()+1, parts.mm - 1, parts.dd);
  return dt;
}

function clearCalendarMatches(){
  const cells = document.querySelectorAll(".day.match");
  for (let i=0;i<cells.length;i++) cells[i].classList.remove("match");
}

function applyCalendarMatches(queryNorm){
  clearCalendarMatches();
  if (!queryNorm) return;

  // Determine which keys match
  const matchKeys = {};
  for (let i=0;i<nameIndex.length;i++){
    const it = nameIndex[i];
    if (it.n.indexOf(queryNorm) !== -1){
      matchKeys[it.key] = true;
    }
  }
  const mm = pad2(viewMonth+1);
  // mark only in current view month for clarity
  const keysInMonth = Object.keys(matchKeys).filter(k => k.indexOf(mm+"-") === 0);
  if (!keysInMonth.length) return;

  const cells = Array.prototype.slice.call(document.querySelectorAll(".day"));
  for (let c=0;c<cells.length;c++){
    const cell = cells[c];
    if (cell.classList.contains("muted")) continue;
    const nEl = cell.querySelector(".n");
    if (!nEl) continue;
    const dayNum = parseInt((nEl.textContent || "").trim(), 10);
    if (!dayNum) continue;
    const key = mm + "-" + pad2(dayNum);
    if (matchKeys[key]) cell.classList.add("match");
  }
}

function renderSearchResults(q){
  const qn = normalizeText(q);
  searchListEl.innerHTML = "";
  searchEmptyEl.style.display = "none";

  if (!qn){
    searchPillEl.textContent = "Digite para buscar";
    clearCalendarMatches();
    return;
  }

  const results = [];
  for (let i=0;i<nameIndex.length;i++){
    const it = nameIndex[i];
    if (it.n.indexOf(qn) !== -1){
      const dt = keyToDateThisOrNext(it.key);
      results.push({ name: it.name, key: it.key, dt, diff: daysBetween(toLocalMidnight(new Date()), dt) });
    }
  }
  results.sort((a,b)=> a.dt - b.dt || a.name.localeCompare(b.name));

  searchPillEl.textContent = results.length ? ("Encontrado: " + results.length) : "Nenhum encontrado";
  if (!results.length){
    searchEmptyEl.style.display = "block";
    clearCalendarMatches();
    return;
  }

  // highlight matches in the current view month
  applyCalendarMatches(qn);

  const maxShow = 18;
  const show = results.slice(0, maxShow);
  for (let i=0;i<show.length;i++){
    const e = show[i];
    const li = document.createElement("li");
    li.className = "li clickable";
    const when = e.diff === 0 ? "hoje" : (e.diff === 1 ? "em 1 dia" : ("em " + e.diff + " dias"));
    li.innerHTML = `<strong>${e.name}</strong><span>${formatDDMM(e.dt)} ¬∑ ${when}</span>`;
    li.addEventListener("click", ()=>{
      viewMonth = e.dt.getMonth();
      viewYear = e.dt.getFullYear();
      render();

      const cells = Array.prototype.slice.call(document.querySelectorAll(".day"));
      const target = cells.find((c)=>{
        const n = c.querySelector(".n");
        if(!n) return false;
        const num = parseInt((n.textContent || "").trim(), 10);
        return num === e.dt.getDate();
      });
      if (target){
        setSelectedCell(target);
        renderDayContent(e.key, e.dt.getDate());
        openModal();
        target.scrollIntoView({behavior:"smooth", block:"center"});
      }
    });
    searchListEl.appendChild(li);
  }

  if (results.length > maxShow){
    const more = document.createElement("div");
    more.className = "small";
    more.style.marginTop = "8px";
    more.textContent = "Mostrando os 18 primeiros. Refine sua busca para ver mais.";
    searchListEl.appendChild(more);
  }
}

// debounce
let _searchT = null;
function onSearchChanged(){
  clearTimeout(_searchT);
  _searchT = setTimeout(()=> renderSearchResults(searchInput.value), 120);
}
searchInput.addEventListener("input", onSearchChanged);
clearSearchBtn.addEventListener("click", ()=>{
  searchInput.value = "";
  renderSearchResults("");
  searchInput.focus();
});
let upcomingWindow = 30; // default

function toLocalMidnight(d){
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}
function daysBetween(a,b){
  const ms = 24*60*60*1000;
  return Math.round((toLocalMidnight(b) - toLocalMidnight(a))/ms);
}
function parseMMDD(key){
  const parts = key.split("-");
  return {mm: parseInt(parts[0],10), dd: parseInt(parts[1],10)};
}

function getUpcomingEvents(windowDays){
  const base = toLocalMidnight(new Date());
  const events = [];
  Object.keys(birthdays).forEach((key)=>{
    const parts = parseMMDD(key);
    // candidate in this year
    let dt = new Date(base.getFullYear(), parts.mm - 1, parts.dd);
    if (dt < base) dt = new Date(base.getFullYear()+1, parts.mm - 1, parts.dd);
    const diff = daysBetween(base, dt);
    if (diff >= 0 && diff <= windowDays){
      (birthdays[key] || []).forEach((name)=>{
        events.push({name, key, dt, diff});
      });
    }
  });
  events.sort((a,b)=> a.dt - b.dt || a.name.localeCompare(b.name));
  return events;
}

function formatDDMM(dt){
  const dd = String(dt.getDate()).padStart(2,"0");
  const mm = String(dt.getMonth()+1).padStart(2,"0");
  return dd + "/" + mm;
}

function renderUpcoming(){
  const ev = getUpcomingEvents(upcomingWindow);
  upcomingListEl.innerHTML = "";
  upcomingEmptyEl.style.display = ev.length ? "none" : "block";
  upCountPillEl.textContent = "üìå " + ev.length + " pessoa(s)";

  ev.slice(0, 18).forEach((e)=>{
    const li = document.createElement("li");
    li.className = "li clickable";
    const when = e.diff === 0 ? "hoje" : (e.diff === 1 ? "em 1 dia" : ("em " + e.diff + " dias"));
    li.innerHTML = `<strong>${e.name}</strong><span>${formatDDMM(e.dt)} ¬∑ ${when}</span>`;
    li.addEventListener("click", ()=>{
      // navigate calendar to the event month/year and open modal on that day
      viewMonth = e.dt.getMonth();
      viewYear = e.dt.getFullYear();
      render();

      // find the day cell matching date
      const cells = Array.prototype.slice.call(document.querySelectorAll(".day"));
      const target = cells.find((c)=>{
        const n = c.querySelector(".n");
        if(!n) return false;
        const dayText = (n.textContent || "").trim();
        const num = parseInt(dayText, 10);
        return num === e.dt.getDate();
      });

      if (target){
        setSelectedCell(target);
        renderDayContent(e.key, e.dt.getDate());
        openModal();
        target.scrollIntoView({behavior:"smooth", block:"center"});
      }
    });
    upcomingListEl.appendChild(li);
  });

  if (ev.length > 18){
    const more = document.createElement("div");
    more.className = "small";
    more.style.marginTop = "8px";
    more.textContent = "Mostrando os 18 primeiros. Aumente o per√≠odo ou navegue pelo calend√°rio para ver todos.";
    upcomingListEl.appendChild(more);
  }
}

function setUpcomingWindow(days){
  upcomingWindow = days;
  up7Btn.classList.remove("primary");
  up15Btn.classList.remove("primary");
  up30Btn.classList.remove("primary");
  if (days === 7) up7Btn.classList.add("primary");
  if (days === 15) up15Btn.classList.add("primary");
  if (days === 30) up30Btn.classList.add("primary");
  renderUpcoming();
  applyCalendarMatches(normalizeText(searchInput.value));
}

up7Btn.addEventListener("click", ()=> setUpcomingWindow(7));
up15Btn.addEventListener("click", ()=> setUpcomingWindow(15));
up30Btn.addEventListener("click", ()=> setUpcomingWindow(30));

const prevBtn  = document.getElementById("prevBtn");
const nextBtn  = document.getElementById("nextBtn");
const todayBtn = document.getElementById("todayBtn");

const modalOverlay = document.getElementById("modalOverlay");
const closeModalBtn = document.getElementById("closeModalBtn");
const modalTitle = document.getElementById("modalTitle");
const modalBody  = document.getElementById("modalBody");

let now = new Date();
let viewMonth = now.getMonth();
let viewYear = now.getFullYear();
let selectedCell = null;

function pad2(n){ return String(n).padStart(2,"0"); }

function showToast(text){
  toastEl.textContent = text;
  toastEl.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toastEl.classList.remove("show"), 1400);
}

function setSelectedCell(cell){
  if (selectedCell) selectedCell.classList.remove("selected");
  selectedCell = cell;
  if (selectedCell) selectedCell.classList.add("selected");
}

function openModal(){
  modalOverlay.classList.add("show");
  modalOverlay.setAttribute("aria-hidden","false");
  document.body.style.overflowX = "hidden";
  document.body.style.overflowY = "hidden";
}
function closeModal(){
  modalOverlay.classList.remove("show");
  modalOverlay.setAttribute("aria-hidden","true");
  document.body.style.overflowX = "hidden";
  document.body.style.overflowY = "auto";
}
closeModalBtn.addEventListener("click", closeModal);
modalOverlay.addEventListener("click", (e)=>{ if (e.target === modalOverlay) closeModal(); });
document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && modalOverlay.classList.contains("show")) closeModal(); });

/* confetti */
const c = document.getElementById("confetti");
const ctx = c.getContext("2d");
let conf = [];
function resizeCanvas(){ c.width = window.innerWidth; c.height = window.innerHeight; }
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

function launchConfetti(){
  const isMobile = window.matchMedia("(max-width: 720px)").matches;
  const count = isMobile ? 34 : 70;
  const colors = ["rgba(22,163,74,.90)","rgba(79,91,255,.90)","rgba(251,113,133,.90)","rgba(20,28,51,.80)"];
  const cx = Math.random()*c.width*0.6 + c.width*0.2;
  const cy = 20;
  for (let i=0;i<count;i++){
    conf.push({
      x: cx, y: cy,
      vx: (Math.random()-0.5)*6,
      vy: Math.random()*-5 - 2.5,
      g: 0.18 + Math.random()*0.08,
      s: 2 + Math.random()*3,
      r: Math.random()*Math.PI,
      vr: (Math.random()-0.5)*0.25,
      life: 70 + Math.random()*30,
      col: colors[Math.floor(Math.random()*colors.length)]
    });
  }
}
function tickConfetti(){
  ctx.clearRect(0,0,c.width,c.height);
  for (let i=conf.length-1;i>=0;i--){
    const p = conf[i];
    p.life -= 1;
    p.vy += p.g;
    p.x += p.vx;
    p.y += p.vy;
    p.r += p.vr;
    ctx.save();
    ctx.translate(p.x,p.y);
    ctx.rotate(p.r);
    ctx.fillStyle = p.col;
    ctx.fillRect(-p.s/2,-p.s/2,p.s*1.3,p.s);
    ctx.restore();
    if (p.life<=0 || p.y>c.height+40) conf.splice(i,1);
  }
  requestAnimationFrame(tickConfetti);
}
tickConfetti();

function countInMonth(m){
  const mm = pad2(m+1);
  let daysCount = 0, peopleCount = 0;
  Object.keys(birthdays).forEach(k=>{
    if(k.indexOf(mm + "-") === 0){
      daysCount++;
      peopleCount += birthdays[k].length;
    }
  });
  return {daysCount, peopleCount};
}

function getMonthObservations(m){
  const mm = pad2(m+1);
  const items = [];
  Object.keys(birthdays).sort().forEach(k=>{
    if(k.indexOf(mm + "-") === 0){
      const dd = k.split("-")[1];
      items.push({dd, names: birthdays[k].slice()});
    }
  });
  return items;
}

function renderMonthObservations(){
  const c = countInMonth(viewMonth);
  monthSummaryEl.textContent = c.daysCount
    ? `Neste m√™s h√° ${c.peopleCount} aniversariante(s) distribu√≠dos em ${c.daysCount} dia(s).`
    : `Sem anivers√°rios cadastrados para este m√™s.`;

  monthListEl.innerHTML = "";
  const obs = getMonthObservations(viewMonth);
  if(!obs.length) return;

  obs.forEach(o=>{
    const li = document.createElement("li");
    li.className = "li";
    li.innerHTML = `<strong>${o.names.join(", ")}</strong><span>${o.dd}/${pad2(viewMonth+1)}</span>`;
    monthListEl.appendChild(li);
  });
}

function renderDayContent(key, day){
  modalBody.innerHTML = "";
  modalTitle.textContent = day + " de " + months[viewMonth];

  const people = birthdays[key];
  if (!people){
    const div = document.createElement("div");
    div.className = "item";
    div.textContent = "Sem aniversariantes neste dia.";
    modalBody.appendChild(div);
    return;
  }

  launchConfetti();

  const parts = key.split("-");
  const mm = parts[0], dd = parts[1];

  people.forEach((name)=>{
    const extra = getExtraMessage(name);
    const msg = extra + "\n\n" + (messages[name] || defaultMsg);
    const wrap = document.createElement("div");
    wrap.className = "item";

    const msgEnc = encodeURIComponent(msg);
    const waText = encodeURIComponent("*"+name+"* - "+dd+"/"+mm+"\n"+msg);

    wrap.innerHTML =
      "<div class='itemTop'><strong>"+name+"</strong><span class='dateTag'>"+dd+"/"+mm+"</span></div>" +
      "<div class='msg'>"+(msg||'').replace(/\n/g,'<br>')+"</div>" +
      "<div class='actions'>" +
        "<button class='smallBtn' type='button' data-copy='"+msgEnc+"'>üìã Copiar</button>" +
        "<button class='smallBtn' type='button' data-wa='"+waText+"'>üü¢ WhatsApp</button>" +
      "</div>";
    modalBody.appendChild(wrap);
  });
}

function render(){
  monthTitleEl.textContent = "üìÖ " + months[viewMonth] + " " + viewYear;
  const c = countInMonth(viewMonth);
  countPillEl.textContent = "üéÇ " + c.peopleCount + " pessoa(s) ¬∑ " + c.daysCount + " dia(s)";

  daysEl.innerHTML = "";
  selectedCell = null;

  renderMonthObservations();

  const firstDow = new Date(viewYear, viewMonth, 1).getDay();
  const total = new Date(viewYear, viewMonth+1, 0).getDate();

  for (let i=0; i<firstDow; i++){
    const div = document.createElement("div");
    div.className = "day muted";
    daysEl.appendChild(div);
  }

  for (let d=1; d<=total; d++){
    const key = pad2(viewMonth+1) + "-" + pad2(d);
    const has = !!birthdays[key];

    const div = document.createElement("div");
    let cls = "day";
    if (has) cls += " bday";
    if (d === now.getDate() && viewMonth === now.getMonth() && viewYear === now.getFullYear()) cls += " today";
    div.className = cls;

    let preview = "";
    if (has){
      const arr = birthdays[key];
      preview = arr.slice(0,2).join(", ");
      if (arr.length>2) preview += "‚Ä¶";
    }

    const badge = has ? " <span class='miniBadge'>üéâ</span>" : "";
    div.innerHTML = "<div class='n'>" + d + badge + "</div>" + (has ? "<div class='p'>" + preview + "</div>" : "");

    div.addEventListener("click", ()=>{
      setSelectedCell(div);
      renderDayContent(key, d);
      openModal();
    });

    daysEl.appendChild(div);
  }
  renderUpcoming();

}

/* copy + whatsapp */
document.addEventListener("click", async (e)=>{
  const btn = e.target.closest("button");
  if (!btn) return;

  if (btn.dataset.copy){
    const msg = decodeURIComponent(btn.dataset.copy);
    try{
      await navigator.clipboard.writeText(msg);
      showToast("Mensagem copiada ‚úÖ");
    }catch(err){
      const ta = document.createElement("textarea");
      ta.value = msg;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      showToast("Copiado ‚úÖ");
    }
  }
  
  if (btn.dataset.wa){
    const text = decodeURIComponent(btn.dataset.wa);
    const url = "https://wa.me/?text=" + encodeURIComponent(text);
    window.open(url, "_blank");
  }
  if (btn.dataset.share){
    const text = decodeURIComponent(btn.dataset.share);
    const title = "Mensagem de anivers√°rio";
    // Web Share API (mobile)
    if (navigator.share){
      try{
        await navigator.share({ title, text });
        showToast("Compartilhado ‚úÖ");
      }catch(err){
        // user cancelled or share failed ‚Äî fall back to copy silently
        try{
          await navigator.clipboard.writeText(text);
          showToast("Copiado ‚úÖ");
        }catch(e2){
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
          showToast("Copiado ‚úÖ");
        }
      }
    }else{
      // Fallback: copy
      try{
        await navigator.clipboard.writeText(text);
        showToast("Copiado ‚úÖ (sem menu de compartilhar)");
      }catch(err){
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        showToast("Copiado ‚úÖ (sem menu de compartilhar)");
      }
    }
  }
});
prevBtn.addEventListener("click", ()=>{ viewMonth--; if (viewMonth<0){ viewMonth=11; viewYear--; } render(); });
nextBtn.addEventListener("click", ()=>{ viewMonth++; if (viewMonth>11){ viewMonth=0; viewYear++; } render(); });
todayBtn.addEventListener("click", ()=>{ now = new Date(); viewMonth = now.getMonth(); viewYear = now.getFullYear(); render(); showToast("Hoje"); });

render();
setUpcomingWindow(30);
renderSearchResults('');
</script>
</body>
</html>
